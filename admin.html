<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenIPTV - ç®¡ç†åå°</title>
    <style>
        :root {
            --primary-color: #3b82f6;
            --danger-color: #ef4444;
            --success-color: #22c55e;
            --secondary-color: #8b5cf6;
            --bg-light: #f1f5f9;
            --bg-dark: #1e293b;
            --text-dark: #334155;
            --text-light: #64748b;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background-color: var(--bg-light); color: var(--text-dark); }
        .hidden { display: none !important; }
        .login-section { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background-color: var(--bg-light); z-index: 100; }
        .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; }
        .login-box h1 { color: var(--dark-gray); margin-bottom: 10px; }
        .login-box .login-intro { color: var(--text-light); margin-bottom: 25px; font-size: 15px; }
        .login-box input { width: 100%; padding: 14px; font-size: 16px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; margin-bottom: 20px; transition: all 0.2s; }
        .login-box input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); outline: none; }
        .login-box button { width: 100%; display: flex; align-items: center; justify-content: center; height: 50px; padding: 14px; font-size: 18px; color: white; background-color: var(--primary-color); border: none; border-radius: 8px; cursor: pointer; position: relative; transition: background-color 0.2s; }
        .login-box button:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .btn-loader { width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .remember-me { display: flex; align-items: center; justify-content: flex-start; margin-bottom: 20px; font-size: 14px; }
        .remember-me input { width: auto; margin: 0 8px 0 0; }
        #login-error { color: var(--danger-color); margin-top: 15px; font-size: 14px; }
        .captcha-container { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        #captcha-canvas { border: 1px solid #cbd5e1; border-radius: 8px; cursor: pointer; }
        #dashboard-section { padding: 20px; max-width: 1400px; margin: auto; }
        .header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; }
        .header h1 { margin: 0; }
        .header .actions { display: flex; gap: 10px; }
        .header button, #logout-btn { padding: 10px 20px; font-size: 16px; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .header button:hover, #logout-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .create-btn { background-color: var(--success-color); }
        .batch-btn { background-color: var(--secondary-color); }
        #logout-btn { background-color: var(--danger-color); }
        .table-container { background: white; border-radius: 12px; overflow-x: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
        th { background-color: var(--bg-light); font-weight: 600; color: var(--text-light); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.05em;}
        td .token { font-family: monospace; background: #e9ecef; padding: 3px 6px; border-radius: 4px; display: inline-block; max-width: 200px; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; cursor: pointer; }
        .delete-btn { background: none; border: 1px solid var(--danger-color); color: var(--danger-color); padding: 5px 10px; border-radius: 5px; cursor: pointer; transition: all 0.2s; }
        .delete-btn:hover { background: var(--danger-color); color: white; }
        #loader { text-align: center; padding: 50px; font-size: 20px; color: #999; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 700px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-content h3 { margin-top: 0; }
        .modal-content textarea { width: 100%; height: 250px; margin-top: 10px; font-family: monospace; border: 1px solid #cbd5e1; border-radius: 5px; padding: 10px; }
        .modal-content button { width: 100%; margin-top: 15px; padding: 10px; border-radius: 5px; border: none; background: var(--primary-color); color: white; cursor: pointer; }
    </style>
</head>
<body>
    <div id="login-section" class="login-section">
        <div class="login-box">
            <h1>ğŸ” ç®¡ç†å‘˜åå°</h1>
            <p class="login-intro">è¯·è¾“å…¥æ‚¨çš„åç«¯æœåŠ¡åœ°å€å’Œç®¡ç†å‘˜å¯†ç </p>
            <input type="text" id="backend-url-input" placeholder="åç«¯æœåŠ¡å™¨åœ°å€, e.g., https://iptv.wans.eu.org">
            <input type="password" id="admin-token-input" placeholder="ç®¡ç†å‘˜å¯†ç  (ADMIN_TOKEN)">
            <div class="captcha-container">
                <input type="text" id="captcha-input" placeholder="è¯·è¾“å…¥å³ä¾§çš„éªŒè¯ç " style="margin-bottom: 0;">
                <canvas id="captcha-canvas" width="120" height="50" onclick="generateCaptcha()"></canvas>
            </div>
            <div class="remember-me">
                <input type="checkbox" id="remember-me-checkbox" checked>
                <label for="remember-me-checkbox">è®°ä½ç™»å½•ä¿¡æ¯</label>
            </div>
            <button id="login-btn" onclick="login()">
                <span class="btn-text">ç™» å½•</span>
                <span class="btn-loader hidden"></span>
            </button>
            <p id="login-error" class="hidden">ç™»å½•å¤±è´¥ï¼è¯·æ£€æŸ¥åœ°å€å’Œå¯†ç ã€‚</p>
        </div>
    </div>
    <div id="dashboard-section" class="hidden"></div>
    <script>
        const storage = () => document.getElementById('remember-me-checkbox')?.checked ? localStorage : sessionStorage;
        let captchaText = '';
        let backendUrl = localStorage.getItem('backendUrl') || sessionStorage.getItem('backendUrl');
        let adminToken = localStorage.getItem('adminToken') || sessionStorage.getItem('adminToken');

        function generateCaptcha() {
            const canvas = document.getElementById('captcha-canvas');
            const ctx = canvas.getContext('2d');
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            captchaText = '';
            for (let i = 0; i < 5; i++) {
                captchaText += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#f1f5f9';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw random lines
            for (let i = 0; i < 5; i++) {
                ctx.strokeStyle = `rgba(${Math.random()*150}, ${Math.random()*150}, ${Math.random()*150}, 0.2)`;
                ctx.beginPath();
                ctx.moveTo(Math.random() * canvas.width, Math.random() * canvas.height);
                ctx.lineTo(Math.random() * canvas.width, Math.random() * canvas.height);
                ctx.stroke();
            }

            // Draw text
            ctx.font = '30px Arial';
            ctx.fillStyle = '#334155';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(captchaText, canvas.width / 2, canvas.height / 2);
        }

        window.onload = () => {
            generateCaptcha();
            const urlInput = document.getElementById('backend-url-input');
            const tokenInput = document.getElementById('admin-token-input');
            if(backendUrl) urlInput.value = backendUrl;
            if(adminToken) tokenInput.value = adminToken;
            
            if (backendUrl && adminToken) {
                login(true);
            }
        };
        
        function renderDashboard() {
            document.getElementById('dashboard-section').innerHTML = `
                <div class="header">
                    <h1>ç”¨æˆ·ç®¡ç†çœ‹æ¿</h1>
                    <div class="actions">
                        <button class="create-btn" onclick="createToken()">+ åˆ›å»ºæ–°ç”¨æˆ·</button>
                        <button class="batch-btn" onclick="batchCreateTokens()">ğŸ“¦ æ‰¹é‡åˆ›å»º</button>
                        <button id="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                    </div>
                </div>
                <p>å…± <strong id="user-count">0</strong> ä½ç”¨æˆ·</p>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>æè¿°</th><th>ç”¨æˆ·Token</th><th>åˆ›å»ºæ—¶é—´</th><th>è®¿é—®æ¬¡æ•°</th><th>æœ€åè®¿é—®</th><th>æ“ä½œ</th></tr>
                        </thead>
                        <tbody id="user-table-body"></tbody>
                    </table>
                    <div id="loader">æ­£åœ¨åŠ è½½ç”¨æˆ·æ•°æ®...</div>
                </div>
            `;
        }
        
        async function showDashboard() {
            document.getElementById('login-section').classList.add('hidden');
            renderDashboard();
            document.getElementById('dashboard-section').classList.remove('hidden');
            await fetchTokens();
        }

        async function login(isAutoLogin = false) {
            const urlInput = document.getElementById('backend-url-input');
            const tokenInput = document.getElementById('admin-token-input');
            const captchaInput = document.getElementById('captcha-input');
            const loginBtn = document.getElementById('login-btn');
            const btnText = loginBtn.querySelector('.btn-text');
            const btnLoader = loginBtn.querySelector('.btn-loader');
            const errorMsg = document.getElementById('login-error');

            if (!isAutoLogin) {
                 if (captchaInput.value.toLowerCase() !== captchaText.toLowerCase()) {
                    alert('éªŒè¯ç é”™è¯¯ï¼');
                    generateCaptcha();
                    captchaInput.value = '';
                    captchaInput.focus();
                    return;
                }
            }
            
            backendUrl = urlInput.value.trim().replace(/\/$/, '');
            adminToken = tokenInput.value;

            if (!backendUrl || !adminToken) {
                if (!isAutoLogin) alert('è¯·è¾“å…¥åç«¯åœ°å€å’Œç®¡ç†å‘˜å¯†ç ï¼');
                return;
            }

            loginBtn.disabled = true;
            btnText.classList.add('hidden');
            btnLoader.classList.remove('hidden');
            errorMsg.classList.add('hidden');

            try {
                const response = await fetch(`${backendUrl}/admin/tokens`, { headers: { 'X-Admin-Token': adminToken } });
                if (response.ok) {
                    const currentStorage = storage();
                    currentStorage.setItem('backendUrl', backendUrl);
                    currentStorage.setItem('adminToken', adminToken);
                    await showDashboard();
                } else { throw new Error('è®¤è¯å¤±è´¥'); }
            } catch (error) {
                if (!isAutoLogin) errorMsg.classList.remove('hidden');
                generateCaptcha(); // ç™»å½•å¤±è´¥ååˆ·æ–°éªŒè¯ç 
            } finally {
                loginBtn.disabled = false;
                btnText.classList.remove('hidden');
                btnLoader.classList.add('hidden');
            }
        }

        function logout() {
            sessionStorage.removeItem('backendUrl');
            sessionStorage.removeItem('adminToken');
            localStorage.removeItem('backendUrl');
            localStorage.removeItem('adminToken');
            window.location.reload();
        }

        async function apiFetch(endpoint, options = {}) {
            const url = `${backendUrl}${endpoint}`;
            const headers = { ...options.headers, 'X-Admin-Token': adminToken };
            if (options.body) { headers['Content-Type'] = 'application/json'; }
            const response = await fetch(url, { ...options, headers });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'è¯·æ±‚å¤±è´¥');
            }
            return response.json();
        }

        async function fetchTokens() {
            const tableBody = document.getElementById('user-table-body');
            const userCount = document.getElementById('user-count');
            const loader = document.getElementById('loader');
            if (!tableBody) return;
            loader.classList.remove('hidden');
            tableBody.innerHTML = '';
            try {
                const tokens = await apiFetch('/admin/tokens');
                const tokenKeys = Object.keys(tokens);
                userCount.textContent = tokenKeys.length;
                if (tokenKeys.length === 0) { loader.textContent = 'æš‚æ— ç”¨æˆ·ã€‚'; return; }
                tokenKeys.sort((a,b) => new Date(tokens[b].created_at) - new Date(tokens[a].created_at));
                tokenKeys.forEach(token => {
                    const userData = tokens[token];
                    const row = document.createElement('tr');
                    const lastAccess = userData.last_access ? new Date(userData.last_access).toLocaleString() : 'ä»æœªè®¿é—®';
                    row.innerHTML = `
                        <td>${userData.description}</td>
                        <td><div class="token" title="ç‚¹å‡»å¤åˆ¶: ${token}" onclick="copyTokenToClipboard('${token}')">${token}</div></td>
                        <td>${new Date(userData.created_at).toLocaleString()}</td>
                        <td>${userData.access_count}</td>
                        <td>${lastAccess}</td>
                        <td><button class="delete-btn" onclick="deleteToken('${token}')">åˆ é™¤</button></td>
                    `;
                    tableBody.appendChild(row);
                });
                loader.classList.add('hidden');
            } catch (error) { if (loader) loader.textContent = `åŠ è½½å¤±è´¥: ${error.message}`; }
        }

        async function createToken() {
            const description = prompt("è¯·è¾“å…¥æ–°ç”¨æˆ·çš„æè¿° (ä¾‹å¦‚: 'ç»™æœ‹å‹å°æ˜ç”¨'):", "");
            if (description === null || description.trim() === "") return;
            try {
                const result = await apiFetch('/admin/tokens', { method: 'POST', body: JSON.stringify({ description }) });
                alert(`åˆ›å»ºæˆåŠŸï¼\næ–°ç”¨æˆ·çš„Tokenæ˜¯: ${result.new_token}`);
                await fetchTokens();
            } catch (error) { alert(`åˆ›å»ºå¤±è´¥: ${error.message}`); }
        }
        
        async function batchCreateTokens() {
            const countStr = prompt("æ‚¨æƒ³ä¸€æ¬¡æ€§åˆ›å»ºå¤šå°‘ä¸ªTokenï¼Ÿ (æœ€å¤š100ä¸ª)", "10");
            if (countStr === null) return;
            const count = parseInt(countStr, 10);
            if (isNaN(count) || count <= 0 || count > 100) { alert("è¯·è¾“å…¥ä¸€ä¸ª1åˆ°100ä¹‹é—´çš„æœ‰æ•ˆæ•°å­—ã€‚"); return; }
            const descriptionPrefix = prompt("è¯·è¾“å…¥è¿™æ‰¹Tokençš„ç»Ÿä¸€æè¿°å‰ç¼€ (ä¾‹å¦‚: 'Bç«™æ´»åŠ¨ç”¨æˆ·')", "æ‰¹é‡åˆ›å»ºçš„ç”¨æˆ·");
            if (descriptionPrefix === null) return;
            try {
                const results = await apiFetch('/admin/tokens/batch', { method: 'POST', body: JSON.stringify({ count, description_prefix: descriptionPrefix }) });
                showBatchResults(results);
                await fetchTokens();
            } catch (error) { alert(`æ‰¹é‡åˆ›å»ºå¤±è´¥: ${error.message}`); }
        }

        function showBatchResults(tokens) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            let resultText = `æˆåŠŸåˆ›å»ºäº† ${tokens.length} ä¸ªæ–°Tokenï¼\n\n`;
            tokens.forEach(item => { resultText += `${item.description}: ${item.token}\n`; });
            overlay.innerHTML = `
                <div class="modal-content">
                    <h3>æ‰¹é‡åˆ›å»ºç»“æœ</h3>
                    <textarea readonly>${resultText}</textarea>
                    <button onclick="this.parentElement.parentElement.remove()">å…³é—­</button>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        async function deleteToken(token) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ (å°ç¦) è¿™ä¸ªç”¨æˆ·å—ï¼Ÿ\nToken: ${token}\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
            try {
                await apiFetch(`/admin/tokens/${token}`, { method: 'DELETE' });
                alert('åˆ é™¤æˆåŠŸï¼è¯¥ç”¨æˆ·çš„è®¿é—®æƒé™å·²è¢«åŠé”€ã€‚');
                await fetchTokens();
            } catch (error) { alert(`åˆ é™¤å¤±è´¥: ${error.message}`); }
        }
        
        function copyTokenToClipboard(token) {
             navigator.clipboard.writeText(token).then(() => {
                alert(`Tokenå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n${token}`);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥: ', err);
            });
        }
    </script>
</body>
</html>
